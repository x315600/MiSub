/**
 * Protocol Converter 单元测试
 * 测试各种协议的转换功能
 */

import { describe, it, expect, vi, beforeEach } from 'vitest'

// 创建mock crypto.randomUUID (在Node环境下可能不存在)
vi.stubGlobal('crypto', {
    randomUUID: () => 'test-uuid-1234'
})

// Mock btoa/atob for Node environment
vi.stubGlobal('btoa', (str) => Buffer.from(str).toString('base64'))
vi.stubGlobal('atob', (str) => Buffer.from(str, 'base64').toString())

// 导入被测试模块
import {
    convertClashProxyToUrl,
    parseSurgeConfig,
    parseQuantumultXConfig
} from '../../src/utils/protocolConverter.js'

describe('protocolConverter', () => {
    describe('convertClashProxyToUrl', () => {
        describe('VMess', () => {
            it('应正确转换基础VMess配置', () => {
                const proxy = {
                    name: 'Test VMess',
                    type: 'vmess',
                    server: '1.2.3.4',
                    port: 443,
                    uuid: 'uuid-1234-5678',
                    alterId: 0,
                    cipher: 'auto',
                    network: 'tcp'
                }

                const result = convertClashProxyToUrl(proxy)
                expect(result).toBeTruthy()
                expect(result).toMatch(/^vmess:\/\//)

                // 解码验证
                const base64Data = result.replace('vmess://', '')
                const decoded = JSON.parse(atob(base64Data))
                expect(decoded.add).toBe('1.2.3.4')
                expect(decoded.port).toBe(443)
                expect(decoded.id).toBe('uuid-1234-5678')
            })

            it('应正确处理WebSocket传输', () => {
                const proxy = {
                    name: 'VMess WS',
                    type: 'vmess',
                    server: 'example.com',
                    port: 443,
                    uuid: 'test-uuid',
                    network: 'ws',
                    tls: true,
                    'ws-opts': {
                        path: '/path',
                        headers: { Host: 'example.com' }
                    }
                }

                const result = convertClashProxyToUrl(proxy)
                expect(result).toBeTruthy()

                const base64Data = result.replace('vmess://', '')
                const decoded = JSON.parse(atob(base64Data))
                expect(decoded.net).toBe('ws')
                expect(decoded.path).toBe('/path')
                expect(decoded.host).toBe('example.com')
            })
        })

        describe('Shadowsocks', () => {
            it('应正确转换SS配置', () => {
                const proxy = {
                    name: 'Test SS',
                    type: 'ss',
                    server: '1.2.3.4',
                    port: 8388,
                    cipher: 'aes-256-gcm',
                    password: 'testpass'
                }

                const result = convertClashProxyToUrl(proxy)
                expect(result).toBeTruthy()
                expect(result).toMatch(/^ss:\/\//)
                expect(result).toContain('#Test%20SS')
            })

            it('缺少必要字段应返回null', () => {
                const proxy = {
                    name: 'Incomplete SS',
                    type: 'ss',
                    server: '1.2.3.4'
                    // 缺少 port, cipher, password
                }

                const result = convertClashProxyToUrl(proxy)
                expect(result).toBeNull()
            })
        })

        describe('Trojan', () => {
            it('应正确转换Trojan配置', () => {
                const proxy = {
                    name: 'Test Trojan',
                    type: 'trojan',
                    server: 'trojan.example.com',
                    port: 443,
                    password: 'secret'
                }

                const result = convertClashProxyToUrl(proxy)
                expect(result).toBeTruthy()
                expect(result).toMatch(/^trojan:\/\//)
                expect(result).toContain('trojan.example.com:443')
            })
        })

        describe('VLESS', () => {
            it('应正确转换VLESS配置', () => {
                const proxy = {
                    name: 'Test VLESS',
                    type: 'vless',
                    server: 'vless.example.com',
                    port: 443,
                    uuid: 'vless-uuid-1234',
                    network: 'tcp',
                    tls: true
                }

                const result = convertClashProxyToUrl(proxy)
                expect(result).toBeTruthy()
                expect(result).toMatch(/^vless:\/\//)
                expect(result).toContain('vless-uuid-1234@vless.example.com:443')
            })

            it('应正确处理Reality配置', () => {
                const proxy = {
                    name: 'VLESS Reality',
                    type: 'vless',
                    server: 'reality.example.com',
                    port: 443,
                    uuid: 'reality-uuid',
                    network: 'tcp',
                    reality: true,
                    'reality-opts': {
                        'public-key': 'test-public-key',
                        'short-id': 'abc123'
                    }
                }

                const result = convertClashProxyToUrl(proxy)
                expect(result).toBeTruthy()
                expect(result).toContain('security=reality')
                expect(result).toContain('publicKey=test-public-key')
            })
        })

        describe('Hysteria2', () => {
            it('应正确转换Hysteria2配置', () => {
                const proxy = {
                    name: 'Test Hy2',
                    type: 'hysteria2',
                    server: 'hy2.example.com',
                    port: 443,
                    password: 'hy2pass'
                }

                const result = convertClashProxyToUrl(proxy)
                expect(result).toBeTruthy()
                expect(result).toMatch(/^hysteria2:\/\//)
            })
        })

        describe('边界情况', () => {
            it('空输入应返回null', () => {
                expect(convertClashProxyToUrl(null)).toBeNull()
                expect(convertClashProxyToUrl(undefined)).toBeNull()
                expect(convertClashProxyToUrl({})).toBeNull()
            })

            it('不支持的类型应返回null', () => {
                const proxy = {
                    name: 'Unknown',
                    type: 'unknown-protocol',
                    server: '1.2.3.4',
                    port: 443
                }
                expect(convertClashProxyToUrl(proxy)).toBeNull()
            })
        })
    })

    describe('parseSurgeConfig', () => {
        it('应正确解析Surge SS配置', () => {
            const config = `
[Proxy]
ss=Test SS,1.2.3.4,8388,aes-256-gcm,password123
`
            const result = parseSurgeConfig(config)
            expect(result.length).toBeGreaterThan(0)
        })
    })

    describe('parseQuantumultXConfig', () => {
        it('应正确解析空配置', () => {
            const result = parseQuantumultXConfig('')
            expect(result).toEqual([])
        })
    })
})
